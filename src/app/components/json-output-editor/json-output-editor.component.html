<div #editorSection [class.maximized]="isMaximized" [class.fullscreen-mode]="isFullScreen" class="editor-section output-section">
    <h3>
        <mat-icon>output</mat-icon>
        <span>Output</span>
        <div *ngIf="isValidJson" class="output-format-selector">
            <mat-button-toggle-group (change)="onToggleOutputFormat()" [value]="selectedOutputFormat">
                <mat-button-toggle value="json">JSON</mat-button-toggle>
                <mat-button-toggle value="yaml">YAML</mat-button-toggle>
            </mat-button-toggle-group>
        </div>
        <div class="spacer"></div>
        <button (click)="copy.emit()" *ngIf="isValidJson" matTooltip="Copy to Clipboard"
                class="copy-btn" mat-icon-button>
            <mat-icon>content_copy</mat-icon>
        </button>
        
        <!-- Features Dropdown -->
        <button [matMenuTriggerFor]="featuresMenu" *ngIf="isValidJson"
                class="features-btn" mat-icon-button matTooltip="JSON Features">
            <mat-icon>account_tree</mat-icon>
        </button>
        <mat-menu #featuresMenu="matMenu">
            <button (click)="onToggleTreeView()" [disabled]="!isValidJson" mat-menu-item>
                <mat-icon>account_tree</mat-icon>
                <span>Tree View</span>
            </button>
            <button (click)="onToggleOutputFormat()" [disabled]="!isValidJson" mat-menu-item>
                <mat-icon>swap_horiz</mat-icon>
                <span>JSON/YAML</span>
            </button>
            <button (click)="onToggleJsonPaths()" [disabled]="!isValidJson" mat-menu-item>
                <mat-icon>route</mat-icon>
                <span>Paths</span>
            </button>
            <button (click)="onToggleSchemaEditor()" [disabled]="!isValidJson" mat-menu-item>
                <mat-icon>check_circle</mat-icon>
                <span>Validate</span>
            </button>
        </mat-menu>
        
        <!-- Export Dropdown -->
        <button [matMenuTriggerFor]="exportMenu" *ngIf="isValidJson" 
                class="export-btn" mat-icon-button matTooltip="Export Options">
            <mat-icon>download</mat-icon>
        </button>
        <mat-menu #exportMenu="matMenu">
            <button (click)="download.emit()" mat-menu-item>
                <mat-icon>download</mat-icon>
                <span>JSON</span>
            </button>
            <button (click)="downloadText.emit()" mat-menu-item>
                <mat-icon>description</mat-icon>
                <span>TXT</span>
            </button>
            <button (click)="convertToCsv.emit()" mat-menu-item>
                <mat-icon>table_chart</mat-icon>
                <span>CSV</span>
            </button>
            <button (click)="convertToXml.emit()" mat-menu-item>
                <mat-icon>code</mat-icon>
                <span>XML</span>
            </button>
            <button (click)="share.emit()" mat-menu-item>
                <mat-icon>share</mat-icon>
                <span>Share</span>
            </button>
        </mat-menu>
        
        <button (click)="toggleOutputMaximize()" [matTooltip]="isFullScreen ? 'Exit Fullscreen (ESC)' : 'Fullscreen'"
                class="maximize-btn" mat-icon-button>
            <mat-icon>{{ isFullScreen ? 'fullscreen_exit' : 'fullscreen' }}</mat-icon>
        </button>
    </h3>

    <div class="editor-wrapper">
        <!-- Text View (Ace Editor) - shown when in text view mode and JSON format -->
        <div #outputEditor
             [class.view-active]="selectedViewMode === 'text' && selectedOutputFormat === 'json'"
             [class.view-inactive]="selectedViewMode !== 'text' || selectedOutputFormat !== 'json'" class="ace-editor output-editor view-container"></div>

        <!-- YAML View - shown when in text view mode and YAML format -->
        <div [class.view-active]="selectedViewMode === 'text' && selectedOutputFormat === 'yaml'"
             [class.view-inactive]="selectedViewMode !== 'text' || selectedOutputFormat !== 'yaml'"
             class="yaml-output view-container">
            <pre>{{ yamlOutput.value }}</pre>
        </div>

        <!-- Tree View - shown when in tree view mode -->
        <div [class.view-active]="selectedViewMode === 'tree' && jsonTreeData"
             [class.view-inactive]="selectedViewMode !== 'tree' || !jsonTreeData"
             class="tree-view view-container">
            <div class="tree-container">
                <ng-container
                        *ngTemplateOutlet="treeNode; context: { $implicit: jsonTreeData, path: '$', level: 0 }"></ng-container>
            </div>
        </div>

        <!-- Table View - shown when in table view mode -->
        <div [class.view-active]="selectedViewMode === 'table' && jsonTreeData"
             [class.view-inactive]="selectedViewMode !== 'table' || !jsonTreeData"
             class="table-view view-container">
            <div class="table-container">
                <table class="json-table">
                    <thead>
                    <tr>
                        <th>Key</th>
                        <th>Type</th>
                        <th>Value</th>
                    </tr>
                    </thead>
                    <tbody>
                    <ng-container
                            *ngTemplateOutlet="tableRow; context: { $implicit: jsonTreeData, path: '$', level: 0 }"></ng-container>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Search Bar for JSON Output -->
        <div *ngIf="showOutputSearchBar && selectedViewMode === 'text' && selectedOutputFormat === 'json'"
             class="search-bar output-search-field">
            <mat-form-field appearance="outline">
                <mat-label>Search</mat-label>
                <input #searchOutput (keyup.enter)="searchInJson(searchOutput.value)" matInput>
                <button (click)="searchInJson(searchOutput.value)" mat-icon-button matSuffix>
                    <mat-icon>search</mat-icon>
                </button>
            </mat-form-field>
            <div class="search-actions">
                <button (click)="findPrevious()" mat-icon-button matTooltip="Previous">
                    <mat-icon>keyboard_arrow_up</mat-icon>
                </button>
                <button (click)="findNext()" mat-icon-button matTooltip="Next">
                    <mat-icon>keyboard_arrow_down</mat-icon>
                </button>
                <button (click)="clearSearch()" mat-icon-button matTooltip="Clear">
                    <mat-icon>close</mat-icon>
                </button>
            </div>
        </div>

        <!-- Search Bar for Tree View -->
        <div *ngIf="showTreeSearchBar && selectedViewMode === 'tree'" class="search-bar tree-search-field">
            <mat-form-field appearance="outline">
                <mat-label>Search in Tree</mat-label>
                <input #searchTree (keyup.enter)="searchInTree(searchTree.value)" matInput>
                <button (click)="searchInTree(searchTree.value)" mat-icon-button matSuffix>
                    <mat-icon>search</mat-icon>
                </button>
            </mat-form-field>
            <div class="search-actions">
                <button (click)="clearTreeSearch()" mat-icon-button matTooltip="Clear">
                    <mat-icon>close</mat-icon>
                </button>
            </div>
        </div>
    </div>

    <!-- Fullscreen overlay for better UX -->
    <div *ngIf="isFullScreen" class="fullscreen-overlay">
        <div class="fullscreen-controls">
            <span>Press ESC to exit fullscreen</span>
            <button (click)="toggleOutputMaximize()" mat-icon-button matTooltip="Exit Fullscreen">
                <mat-icon>close</mat-icon>
            </button>
        </div>
    </div>
</div>

<!-- Tree Node Template -->
<ng-template #treeNode let-level="level" let-node let-path="path">
    <div [style.padding-left.px]="level * 20" class="tree-level">
        <!-- Object Node -->
        <div *ngIf="isObject(node) && !isArray(node)">
            <div (click)="onToggleNode(path)" class="tree-node">
                <mat-icon [class.expanded]="isNodeExpanded(path)" class="tree-icon">chevron_right</mat-icon>
                <span class="node-label">{{ path === '$' ? 'Root Object' : path.split('.').pop() }}</span>
                <span class="node-info">{{ '{' }} {{ getObjectKeys(node).length }} {{ getObjectKeys(node).length === 1 ? 'property' : 'properties' }} {{ '}' }}</span>
            </div>
            <div [class.collapsed]="!isNodeExpanded(path)" class="tree-children">
                <ng-container *ngFor="let key of getObjectKeys(node)">
                    <ng-container
                            *ngTemplateOutlet="treeNode; context: { $implicit: node[key], path: path + '.' + key, level: level + 1 }"></ng-container>
                </ng-container>
            </div>
        </div>

        <!-- Array Node -->
        <div *ngIf="isArray(node)">
            <div (click)="onToggleNode(path)" class="tree-node">
                <mat-icon [class.expanded]="isNodeExpanded(path)" class="tree-icon">chevron_right</mat-icon>
                <span class="node-label">{{ path === '$' ? 'Root Array' : path.split('.').pop() }}</span>
                <span class="node-info">{{ '[' }} {{ node.length }} {{ node.length === 1 ? 'item' : 'items' }} {{ ']' }}</span>
            </div>
            <div [class.collapsed]="!isNodeExpanded(path)" class="tree-children">
                <ng-container *ngFor="let item of node; let i = index">
                    <ng-container
                            *ngTemplateOutlet="treeNode; context: { $implicit: item, path: path + '[' + i + ']', level: level + 1 }"></ng-container>
                </ng-container>
            </div>
        </div>

        <!-- Primitive Values -->
        <div *ngIf="!isObject(node) && !isArray(node)" class="tree-leaf">
            <span class="node-label">{{ path === '$' ? 'Value' : path.split('.').pop() }}</span>
            <span [ngClass]="{
              'string-value': isString(node),
              'number-value': isNumber(node),
              'boolean-value': isBoolean(node),
              'null-value': node === null
            }" class="node-value">{{ formatValue(node) }}</span>
        </div>
    </div>
</ng-template>

<!-- Table Row Template -->
<ng-template #tableRow let-level="level" let-node let-path="path">
    <!-- Object Row -->
    <ng-container *ngIf="isObject(node) && !isArray(node)">
        <tr (click)="onToggleNode(path)" [class.expandable]="true">
            <td class="key-cell">
                <span [style.padding-left.px]="level * 20" class="indent"></span>
                <mat-icon [class.expanded]="isNodeExpanded(path)" class="tree-icon">chevron_right</mat-icon>
                <span>{{ path === '$' ? 'Root Object' : path.split('.').pop() }}</span>
            </td>
            <td class="type-cell">Object</td>
            <td class="value-cell">{{ '{' }} {{ getObjectKeys(node).length }} {{ getObjectKeys(node).length === 1 ? 'property' : 'properties' }} {{ '}' }}</td>
        </tr>
        <ng-container *ngIf="isNodeExpanded(path)">
            <ng-container *ngFor="let key of getObjectKeys(node)">
                <ng-container
                        *ngTemplateOutlet="tableRow; context: { $implicit: node[key], path: path + '.' + key, level: level + 1 }"></ng-container>
            </ng-container>
        </ng-container>
    </ng-container>

    <!-- Array Row -->
    <ng-container *ngIf="isArray(node)">
        <tr (click)="onToggleNode(path)" [class.expandable]="true">
            <td class="key-cell">
                <span [style.padding-left.px]="level * 20" class="indent"></span>
                <mat-icon [class.expanded]="isNodeExpanded(path)" class="tree-icon">chevron_right</mat-icon>
                <span>{{ path === '$' ? 'Root Array' : path.split('.').pop() }}</span>
            </td>
            <td class="type-cell">Array</td>
            <td class="value-cell">{{ '[' }} {{ node.length }} {{ node.length === 1 ? 'item' : 'items' }} {{ ']' }}</td>
        </tr>
        <ng-container *ngIf="isNodeExpanded(path)">
            <ng-container *ngFor="let item of node; let i = index">
                <ng-container
                        *ngTemplateOutlet="tableRow; context: { $implicit: item, path: path + '[' + i + ']', level: level + 1 }"></ng-container>
            </ng-container>
        </ng-container>
    </ng-container>

    <!-- Primitive Value Row -->
    <ng-container *ngIf="!isObject(node) && !isArray(node)">
        <tr>
            <td class="key-cell">
                <span [style.padding-left.px]="level * 20" class="indent"></span>
                <span>{{ path === '$' ? 'Value' : path.split('.').pop() }}</span>
            </td>
            <td class="type-cell">
                <span *ngIf="isString(node)">String</span>
                <span *ngIf="isNumber(node)">Number</span>
                <span *ngIf="isBoolean(node)">Boolean</span>
                <span *ngIf="node === null">Null</span>
            </td>
            <td [ngClass]="{
                'string-value': isString(node),
                'number-value': isNumber(node),
                'boolean-value': isBoolean(node),
                'null-value': node === null
            }" class="value-cell">{{ formatValue(node) }}
            </td>
        </tr>
    </ng-container>
</ng-template>